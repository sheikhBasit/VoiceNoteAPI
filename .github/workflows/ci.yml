name: CI - Fast Tests on PR

on:
  pull_request:
    branches: [main, staging, develop]
  push:
    branches: [develop, staging]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-format:
    name: ðŸ” Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort pylint

      - name: Run Black (Format Check)
        run: black --check app/ tests/
        continue-on-error: true

      - name: Run isort (Import Check)
        run: isort --check-only app/ tests/
        continue-on-error: true

      - name: Run Flake8 (Lint)
        run: |
          flake8 app/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: Run Pylint
        run: pylint app/ --exit-zero --disable=all --enable=C,E,F,W
        continue-on-error: true

  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit (Security Scan)
        run: bandit -r app/ -ll -ii -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Run Safety (Dependency Check)
        run: safety check --json || true
        continue-on-error: true

  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: ankane/pgvector:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: voicenote_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run Unit Tests (Fast Only)
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:password@localhost:5432/voicenote_test"
          REDIS_URL: "redis://localhost:6379/0"
          ENVIRONMENT: "testing"
          DEVICE_SECRET_KEY: "VN_SECURE_TEST_KEY"
          PYTHONPATH: .
        run: |
          pytest tests/test_core.py tests/test_main.py -v --tb=short --timeout=10
        timeout-minutes: 10

  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: ankane/pgvector:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: voicenote_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run Integration Tests
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:password@localhost:5432/voicenote_test"
          REDIS_URL: "redis://localhost:6379/0"
          ENVIRONMENT: "testing"
          DEVICE_SECRET_KEY: "VN_SECURE_TEST_KEY"
          PYTHONPATH: .
        run: |
          pytest tests/test_new_endpoints.py tests/test_admin_system.py -v --tb=short --timeout=30 -m "not load and not stress and not performance"
        timeout-minutes: 15

  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, lint-and-format, security-scan]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "âœ… All CI checks completed!"
          echo "Status: ${{ job.status }}"

  deploy-to-dev:
    name: ðŸš€ Deploy to Dev
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Dev
        env:
          DEPLOY_KEY: ${{ secrets.DEV_DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEV_HOST }}
          DEPLOY_USER: ${{ secrets.DEV_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            cd voicenote-api
            git pull origin develop
            docker-compose down
            docker-compose up -d
            sleep 5
            curl -f http://localhost:8000/health || exit 1
          EOF

      - name: Notify Deployment
        if: success()
        run: echo "âœ… Deployed to Dev successfully!"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ Dev deployment failed!"

  deploy-to-staging:
    name: ðŸŒ Deploy to Staging
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Staging
        env:
          DEPLOY_KEY: ${{ secrets.STAGING_DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.STAGING_HOST }}
          DEPLOY_USER: ${{ secrets.STAGING_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            cd voicenote-api
            git pull origin staging
            docker-compose down
            docker-compose up -d
            sleep 5
            curl -f http://localhost:8000/health || exit 1
          EOF

      - name: Notify Deployment
        if: success()
        run: echo "âœ… Deployed to Staging successfully!"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ Staging deployment failed!"
