name: VoiceNote CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-and-security:
    name: Lint and Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Linting Tools
        run: |
          pip install flake8 bandit
          
      - name: Run Flake8 (Lint)
        run: |
          # ignore E501 (line length) and other common noisy ones
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          
      - name: Run Bandit (Security Scan)
        run: |
          bandit -r app/ -ll -ii

  test:
    name: Run Tests
    needs: lint-and-security
    runs-on: ubuntu-latest
    services:
      postgres:
        image: ankane/pgvector:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: voicenote_test
        ports:
          - 5432:5432
        # Wait for postgres to be ready
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run Pytest
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:password@localhost:5432/voicenote_test"
          REDIS_URL: "redis://localhost:6379/0"
          ENVIRONMENT: "testing"
          DEVICE_SECRET_KEY: "VN_SECURE_TEST_KEY"
          PYTEST_DB_NAME: "voicenote_test"
          PYTHONPATH: .
        run: |
          python -m pytest tests/integration/test_new_endpoints.py -v --tb=short

  build-and-push:
    name: Build and Push Docker Images
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ab745
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Build and Push API Image
        uses: docker/build-push-action@v5
        env:
          DOCKER_BUILDKIT: 1
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ab745/voicenote-api:latest

  deploy:
    name: Deploy to Production
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: SSH and Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_USERNAME: ab745
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          envs: DOCKER_USERNAME,DOCKER_PASSWORD
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e  # Exit on error
            
            # Login to Docker Hub to fix rate limit
            echo "$DOCKER_PASSWORD" | sudo docker login -u "$DOCKER_USERNAME" --password-stdin
            
            cd /home/${{ secrets.SERVER_USER }}/voicenote-project/VoiceNoteAPI
            
            # Pull latest code
            git pull origin main
            
            # Stop containers and REMOVE VOLUMES (Reset DB)
            sudo docker compose down -v
            
            # Reclaim disk space and remove old volumes (Aggressive prune)
            sudo docker system prune -af
            
            # Force remove potentially conflicting containers (Fix for name conflict)
            sudo docker rm -f voicenote_node_exporter voicenote_api voicenote_db voicenote_redis || true

            sudo docker volume prune -f
            
            # Pull latest images
            sudo docker compose pull
            
            # Start all services with fresh state
            sudo docker compose up -d --no-build
            
            # Robust targeted health check
            echo "Waiting for core services (db, redis, api) to be healthy..."
            for i in {1..40}; do
              DB_HEALTH=$(sudo docker inspect --format='{{.State.Health.Status}}' voicenote_db 2>/dev/null || echo "not-found")
              REDIS_HEALTH=$(sudo docker inspect --format='{{.State.Health.Status}}' voicenote_redis 2>/dev/null || echo "not-found")
              API_HEALTH=$(sudo docker inspect --format='{{.State.Health.Status}}' voicenote_api 2>/dev/null || echo "not-found")
              API_STATE=$(sudo docker inspect --format='{{.State.Status}}' voicenote_api 2>/dev/null || echo "not-found")
              
              echo "   Status ($i/40): DB=$DB_HEALTH, Redis=$REDIS_HEALTH, API=$API_HEALTH (State=$API_STATE)"
              
              if [ "$DB_HEALTH" = "healthy" ] && [ "$REDIS_HEALTH" = "healthy" ] && [ "$API_HEALTH" = "healthy" ]; then
                echo "✅ All core services are healthy!"
                break
              fi
              
              # Force restart API if dependencies are healthy but API is not running/restarting
              if [ "$DB_HEALTH" = "healthy" ] && [ "$REDIS_HEALTH" = "healthy" ]; then
                if [ "$API_STATE" != "running" ] && [ "$API_STATE" != "starting" ]; then
                  echo "⚠️ API service in state '$API_STATE'. Force starting API..."
                  sudo docker compose up -d api
                fi
              fi
              
              sleep 3
              if [ $i -eq 40 ]; then
                echo "❌ Timeout waiting for services to be healthy."
                sudo docker compose ps
                sudo docker compose logs db
                sudo docker compose logs api
                exit 1
              fi
            done
            
            # Run migrations (Fail loudly if this errors)
            echo "Running database migrations..."
            sudo docker compose exec -T api alembic -c /app/alembic.ini upgrade head
            
            # Verify migration status
            echo "Verifying migration state..."
            sudo docker compose exec -T api alembic current
            
            # Verify deployment
            sudo docker compose ps
            
            # Run tests and dump logs on failure
            if ! sudo bash scripts/test/test_all_endpoints_curl.sh; then
              echo "❌ Tests failed. Dumping API logs for debugging:"
              sudo docker compose logs api --tail=500
              exit 1
            fi
