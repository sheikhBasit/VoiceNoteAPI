Warning: deepgram SDK not available or incompatible, websockets will fail.
{"timestamp": "2026-02-07T17:17:39.374570+00:00", "level": "INFO", "logger": "VoiceNote", "message": "Testing endpoints enabled (non-production environment)", "filename": "main.py", "funcName": "<module>", "lineno": 290, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/main.py"}
Creating tables...
Tables created.
{"timestamp": "2026-02-07T17:17:39.420669+00:00", "level": "INFO", "logger": "VoiceNote", "message": "Application starting up: Warming up AI models...", "filename": "main.py", "funcName": "lifespan", "lineno": 54, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/main.py"}
{"timestamp": "2026-02-07T17:17:39.420980+00:00", "level": "INFO", "logger": "VoiceNote", "message": "Loading local embedding model: all-MiniLM-L6-v2", "filename": "ai_service.py", "funcName": "_get_local_embedding_model", "lineno": 74, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/services/ai_service.py"}
{"timestamp": "2026-02-07T17:17:39.422243+00:00", "level": "INFO", "logger": "VoiceNote", "message": "Model warmup complete.", "filename": "main.py", "funcName": "lifespan", "lineno": 60, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/main.py"}
{"timestamp": "2026-02-07T17:17:54.269446+00:00", "level": "INFO", "logger": "VoiceNote.Billing", "message": "Creating new wallet for user 8d9717a2-f0c2-40fa-b0c7-05e52f36f24a", "filename": "billing_service.py", "funcName": "get_or_create_wallet", "lineno": 25, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/services/billing_service.py"}
{"timestamp": "2026-02-07T17:17:54.551843+00:00", "level": "ERROR", "logger": "VoiceNote", "message": "Unhandled exception caught by global handler", "filename": "main.py", "funcName": "global_exception_handler", "lineno": 254, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/main.py", "path": "/api/v1/notes/create", "method": "POST", "exception": "  + Exception Group Traceback (most recent call last):\n  |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_utils.py\", line 77, in collapse_excgroups\n  |     yield\n  |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 183, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |                ~~~~~~~~~~~~~~~~~~~~~~~^^\n  |   File \"/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py\", line 783, in __aexit__\n  |     raise BaseExceptionGroup(\n  |         \"unhandled errors in a TaskGroup\", self._exceptions\n  |     ) from None\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/mnt/muaaz/VoiceNoteAPI/app/main.py\", line 328, in __call__\n    |     await self.app(scope, receive_cached, send)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 182, in __call__\n    |     with recv_stream, send_stream, collapse_excgroups():\n    |                                    ~~~~~~~~~~~~~~~~~~^^\n    |   File \"/home/aoi/miniconda3/lib/python3.13/contextlib.py\", line 162, in __exit__\n    |     self.gen.throw(value)\n    |     ~~~~~~~~~~~~~~^^^^^^^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_utils.py\", line 83, in collapse_excgroups\n    |     raise exc\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 184, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/mnt/muaaz/VoiceNoteAPI/app/api/middleware/usage.py\", line 123, in dispatch\n    |     response = await call_next(request)\n    |                ^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    |     raise app_exc\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/home/aoi/miniconda3/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    |     raise exc\n    |   File \"/home/aoi/miniconda3/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    |     await self.app(scope, receive, send_wrapper)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/gzip.py\", line 29, in __call__\n    |     await responder(scope, receive, send)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/gzip.py\", line 46, in __call__\n    |     await self.app(scope, receive, self.send_with_compression)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 78, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 75, in app\n    |     response = await f(request)\n    |                ^^^^^^^^^^^^^^^^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/fastapi/routing.py\", line 302, in app\n    |     raw_response = await run_endpoint_function(\n    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |     ...<3 lines>...\n    |     )\n    |     ^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/fastapi/routing.py\", line 215, in run_endpoint_function\n    |     return await run_in_threadpool(dependant.call, **values)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/concurrency.py\", line 38, in run_in_threadpool\n    |     return await anyio.to_thread.run_sync(func)\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/to_thread.py\", line 63, in run_sync\n    |     return await get_async_backend().run_sync_in_worker_thread(\n    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |         func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |     )\n    |     ^\n    |   File \"/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py\", line 2502, in run_sync_in_worker_thread\n    |     return await future\n    |            ^^^^^^^^^^^^\n    |   File \"/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py\", line 986, in run\n    |     result = context.run(func, *args)\n    |   File \"/mnt/muaaz/VoiceNoteAPI/app/api/notes.py\", line 228, in create_note\n    |     user_id=current_user.id,\n    |             ^^^^^^^^^^^^^^^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py\", line 569, in __get__\n    |     return self.impl.get(state, dict_)  # type: ignore[no-any-return]\n    |            ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py\", line 1096, in get\n    |     value = self._fire_loader_callables(state, key, passive)\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py\", line 1126, in _fire_loader_callables\n    |     return state._load_expired(state, passive)\n    |            ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/state.py\", line 803, in _load_expired\n    |     self.manager.expired_attribute_loader(self, toload, passive)\n    |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n    |   File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/loading.py\", line 1603, in load_scalar_attributes\n    |     raise orm_exc.DetachedInstanceError(\n    |     ...<2 lines>...\n    |     )\n    | sqlalchemy.orm.exc.DetachedInstanceError: Instance <User at 0x7fab4f6d3ed0> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/mnt/muaaz/VoiceNoteAPI/app/main.py\", line 328, in __call__\n    await self.app(scope, receive_cached, send)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 182, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/aoi/miniconda3/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_utils.py\", line 83, in collapse_excgroups\n    raise exc\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 184, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/mnt/muaaz/VoiceNoteAPI/app/api/middleware/usage.py\", line 123, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 159, in call_next\n    raise app_exc\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/aoi/miniconda3/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/aoi/miniconda3/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/gzip.py\", line 29, in __call__\n    await responder(scope, receive, send)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/gzip.py\", line 46, in __call__\n    await self.app(scope, receive, self.send_with_compression)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 78, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py\", line 75, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/fastapi/routing.py\", line 302, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/fastapi/routing.py\", line 215, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/starlette/concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/to_thread.py\", line 63, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py\", line 2502, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py\", line 986, in run\n    result = context.run(func, *args)\n  File \"/mnt/muaaz/VoiceNoteAPI/app/api/notes.py\", line 228, in create_note\n    user_id=current_user.id,\n            ^^^^^^^^^^^^^^^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py\", line 569, in __get__\n    return self.impl.get(state, dict_)  # type: ignore[no-any-return]\n           ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py\", line 1096, in get\n    value = self._fire_loader_callables(state, key, passive)\n  File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py\", line 1126, in _fire_loader_callables\n    return state._load_expired(state, passive)\n           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/state.py\", line 803, in _load_expired\n    self.manager.expired_attribute_loader(self, toload, passive)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/loading.py\", line 1603, in load_scalar_attributes\n    raise orm_exc.DetachedInstanceError(\n    ...<2 lines>...\n    )\nsqlalchemy.orm.exc.DetachedInstanceError: Instance <User at 0x7fab4f6d3ed0> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)"}
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/aoi/.local/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |         self.scope, self.receive, self.send
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    |     return await self.app(scope, receive, send)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/mnt/muaaz/VoiceNoteAPI/app/main.py", line 328, in __call__
    |     await self.app(scope, receive_cached, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/home/aoi/miniconda3/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/mnt/muaaz/VoiceNoteAPI/app/api/middleware/usage.py", line 123, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/aoi/miniconda3/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 177, in __call__
    |     raise exc
    |   File "/home/aoi/miniconda3/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 175, in __call__
    |     await self.app(scope, receive, send_wrapper)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    |     await responder(scope, receive, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    |     await self.app(scope, receive, self.send_with_compression)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/fastapi/routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<3 lines>...
    |     )
    |     ^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/fastapi/routing.py", line 215, in run_endpoint_function
    |     return await run_in_threadpool(dependant.call, **values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/starlette/concurrency.py", line 38, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/to_thread.py", line 63, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |         func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 2502, in run_sync_in_worker_thread
    |     return await future
    |            ^^^^^^^^^^^^
    |   File "/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 986, in run
    |     result = context.run(func, *args)
    |   File "/mnt/muaaz/VoiceNoteAPI/app/api/notes.py", line 228, in create_note
    |     user_id=current_user.id,
    |             ^^^^^^^^^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 569, in __get__
    |     return self.impl.get(state, dict_)  # type: ignore[no-any-return]
    |            ~~~~~~~~~~~~~^^^^^^^^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1096, in get
    |     value = self._fire_loader_callables(state, key, passive)
    |   File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1126, in _fire_loader_callables
    |     return state._load_expired(state, passive)
    |            ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/state.py", line 803, in _load_expired
    |     self.manager.expired_attribute_loader(self, toload, passive)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/loading.py", line 1603, in load_scalar_attributes
    |     raise orm_exc.DetachedInstanceError(
    |     ...<2 lines>...
    |     )
    | sqlalchemy.orm.exc.DetachedInstanceError: Instance <User at 0x7fab4f6d3ed0> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/aoi/.local/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        self.scope, self.receive, self.send
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/home/aoi/.local/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/mnt/muaaz/VoiceNoteAPI/app/main.py", line 328, in __call__
    await self.app(scope, receive_cached, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/home/aoi/miniconda3/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/mnt/muaaz/VoiceNoteAPI/app/api/middleware/usage.py", line 123, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/aoi/miniconda3/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 177, in __call__
    raise exc
  File "/home/aoi/miniconda3/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py", line 175, in __call__
    await self.app(scope, receive, send_wrapper)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    await responder(scope, receive, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    await self.app(scope, receive, self.send_with_compression)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/fastapi/routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/home/aoi/.local/lib/python3.13/site-packages/fastapi/routing.py", line 215, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/starlette/concurrency.py", line 38, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/to_thread.py", line 63, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 2502, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/home/aoi/miniconda3/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 986, in run
    result = context.run(func, *args)
  File "/mnt/muaaz/VoiceNoteAPI/app/api/notes.py", line 228, in create_note
    user_id=current_user.id,
            ^^^^^^^^^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 569, in __get__
    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1096, in get
    value = self._fire_loader_callables(state, key, passive)
  File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1126, in _fire_loader_callables
    return state._load_expired(state, passive)
           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/state.py", line 803, in _load_expired
    self.manager.expired_attribute_loader(self, toload, passive)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/aoi/.local/lib/python3.13/site-packages/sqlalchemy/orm/loading.py", line 1603, in load_scalar_attributes
    raise orm_exc.DetachedInstanceError(
    ...<2 lines>...
    )
sqlalchemy.orm.exc.DetachedInstanceError: Instance <User at 0x7fab4f6d3ed0> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)
{"timestamp": "2026-02-07T17:18:13.967916+00:00", "level": "ERROR", "logger": "VoiceNote", "message": "Failed to create note in database", "filename": "notes.py", "funcName": "create_note", "lineno": 248, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/api/notes.py", "user_id": "8d9717a2-f0c2-40fa-b0c7-05e52f36f24a", "error": "\nRetry limit exceeded while trying to reconnect to the Celery redis result store backend. The Celery application must be restarted.\n"}
{"timestamp": "2026-02-07T17:18:33.597032+00:00", "level": "ERROR", "logger": "VoiceNote", "message": "Failed to create note in database", "filename": "notes.py", "funcName": "create_note", "lineno": 248, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/api/notes.py", "user_id": "8d9717a2-f0c2-40fa-b0c7-05e52f36f24a", "error": "\nRetry limit exceeded while trying to reconnect to the Celery redis result store backend. The Celery application must be restarted.\n"}
{"timestamp": "2026-02-07T17:18:53.221324+00:00", "level": "ERROR", "logger": "VoiceNote", "message": "Failed to create note in database", "filename": "notes.py", "funcName": "create_note", "lineno": 248, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/api/notes.py", "user_id": "8d9717a2-f0c2-40fa-b0c7-05e52f36f24a", "error": "\nRetry limit exceeded while trying to reconnect to the Celery redis result store backend. The Celery application must be restarted.\n"}
{"timestamp": "2026-02-07T17:19:12.821813+00:00", "level": "ERROR", "logger": "VoiceNote", "message": "Failed to create note in database", "filename": "notes.py", "funcName": "create_note", "lineno": 248, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/api/notes.py", "user_id": "8d9717a2-f0c2-40fa-b0c7-05e52f36f24a", "error": "\nRetry limit exceeded while trying to reconnect to the Celery redis result store backend. The Celery application must be restarted.\n"}
{"timestamp": "2026-02-07T17:35:22.367050+00:00", "level": "INFO", "logger": "VoiceNote", "message": "Application shutting down...", "filename": "main.py", "funcName": "lifespan", "lineno": 67, "pathname": "/mnt/muaaz/VoiceNoteAPI/app/main.py"}
